function registrarEmprestimo(assinatura) {
    const nome = document.getElementById('nomeEmprestimo').value.trim();
    ferramentasSelecionadas.forEach(item => {
        const ferramenta = estoque.find(f => f.id == item.ferramentaId);
        ferramenta.emprestadas += item.quantidade;
        
        const emprestimo = {
            id: Date.now() + Math.random(),
            nome: nome,
            ferramentaId: item.ferramentaId,
            ferramentaNome: item.ferramentaNome,
            quantidade: item.quantidade,
            dataEmprestimo: new Date().toLocaleString('pt-BR'),
            assinaturaEmprestimo: assinatura,
            devolvido: false
        };
        emprestimos.push(emprestimo);
        historico.push({...emprestimo, tipo: 'Empréstimo'});
    });
    salvarDados();
    atualizarTabelaHistorico(); // <-- CORREÇÃO ADICIONADA
    atualizarTabelaEstoque();
    
    const totalFerramentas = ferramentasSelecionadas.length;
    document.getElementById('nomeEmprestimo').value = '';
    document.getElementById('quantidadeEmprestimo').value = '1';
    ferramentasSelecionadas.length = 0;
    atualizarListaFerramentasEmprestimo();
    alert(`Empréstimo registrado com sucesso! Total: ${totalFerramentas} ferramentas`);
}

function registrarDevolucao(assinatura) {
    const emprestimoSelect = document.getElementById('emprestimoSelect');
    const emprestimoId = emprestimoSelect.value;
    
    if(!emprestimoId) {
        alert('Erro ao processar devolução!');
        return;
    }
    
    const emprestimo = emprestimos.find(e => e.id == emprestimoId);
    if(!emprestimo) {
        alert('Empréstimo não encontrado!');
        return;
    }
    
    const ferramenta = estoque.find(f => f.id == emprestimo.ferramentaId);
    if(!ferramenta) {
        alert('Ferramenta não encontrada no estoque!');
        return;
    }
    
    ferramenta.emprestadas -= emprestimo.quantidade;
    if(ferramenta.emprestadas < 0) ferramenta.emprestadas = 0;
    
    emprestimo.devolvido = true;
    emprestimo.dataDevolucao = new Date().toLocaleString('pt-BR');
    emprestimo.assinaturaDevolucao = assinatura;
    
    historico.push({...emprestimo, tipo: 'Devolução'});
    salvarDados();
    atualizarTabelaHistorico(); // <-- CORREÇÃO ADICIONADA
    atualizarSelectEmprestimos();
    atualizarTabelaEstoque();
    
    document.getElementById('emprestimoSelect').value = '';
    document.getElementById('nomeDevolucao').value = '';
    document.getElementById('ferramentaDevolucao').value = '';
    document.getElementById('quantidadeDevolucao').value = '';
    
    alert(`Devolução registrada com sucesso! ${emprestimo.ferramentaNome} (${emprestimo.quantidade})`);
}
